#!/usr/bin/env python3
import argparse
import os
import sys
import traceback
from pathlib import Path

# Add cli directory to path
CLI_DIR = Path(__file__).parent.parent / "cli"
sys.path.insert(0, str(CLI_DIR))

DEBUG = os.environ.get("DEBUG", "0") == "1"


def main():
    parser = argparse.ArgumentParser(
        description="Pi Bridge - Raspberry Pi AP management",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Commands:
  setup         Configure the Pi as a wireless access point
  update-creds  Update AP SSID and/or passphrase
  status        Show AP status and connected clients
  restart       Restart all AP services
  start         Start the AP
  stop          Stop the AP
  clients       List connected clients
  logs          View service logs (hostapd, dnsmasq)
  forwarding    Manage NAT forwarding interfaces
"""
    )
    parser.add_argument("command", nargs="?", help="Command to run")
    parser.add_argument("--use-defaults", action="store_true",
                        help="Use all defaults (for setup command)")

    args, remaining = parser.parse_known_args()

    if args.command == "setup":
        from setup import main as setup_main
        # Re-parse with setup's argument parser
        sys.argv = ["pi-bridge setup"] + remaining
        if args.use_defaults:
            sys.argv.append("--use-defaults")
        setup_main()
    elif args.command == "update-creds":
        from update_creds import main as update_creds_main
        update_creds_main()
    elif args.command == "status":
        from status import main as status_main
        status_main()
    elif args.command == "restart":
        from restart import main as restart_main
        restart_main()
    elif args.command == "start":
        from ap_control import start_ap
        start_ap()
    elif args.command == "stop":
        from ap_control import stop_ap
        stop_ap()
    elif args.command == "clients":
        from clients import main as clients_main
        clients_main()
    elif args.command == "logs":
        from logs import main as logs_main
        sys.argv = ["pi-bridge logs"] + remaining
        logs_main()
    elif args.command == "forwarding":
        from forwarding import main as forwarding_main
        sys.argv = ["pi-bridge forwarding"] + remaining
        forwarding_main()
    elif args.command is None:
        parser.print_help()
    else:
        print(f"Unknown command: {args.command}", file=sys.stderr)
        parser.print_help()
        sys.exit(1)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nAborted.", file=sys.stderr)
        sys.exit(130)
    except Exception as e:
        if DEBUG:
            traceback.print_exc()
        else:
            print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)
